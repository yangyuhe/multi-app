<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Whistle插件</title>
    <script src="./jquery-3.7.1.min.js"></script>
    <script src="./lodash-4.17.21.min.js"></script>
    <style>
      input {
        width: 300px;
      }
    </style>
  </head>
  <body>
    <button class="add-domain" style="margin-bottom: 10px">添加域名</button>
    <button class="apply" disabled style="margin-bottom: 10px">应用</button>
    <form
      enctype="multipart/form-data"
      class="form"
      method="post"
      action="/post"
    ></form>
  </body>
  <script>
    const renderPlugin = (prefix, index, name, value) => {
      return `<div class="plugin-item" style="margin-bottom:5px;">
          <label>plugin名称：<input required name="${prefix}.plugin[${index}].name" value="${name}"/></label>
          <label>地址：<input required name="${prefix}.plugin[${index}].url" value="${value}"/></label>
        </div>`;
    };
    const renderDomain = (index, domain, plugins) => {
      const pluginItems = plugins.map((item, subindex) => {
        return renderPlugin(`[${index}]`, subindex, item.name, item.url);
      });
      const pluginHtml = `<div class="plugin-block" style="border:1px black dashed;padding:5px;margin-top:5px;">
          ${
            pluginItems.length > 0
              ? pluginItems.join("")
              : renderPlugin(`[${index}]`, 0, "", "")
          }
        </div>`;
      return `<div data-index="${index}"" class="domain-block" style="padding: 5px; border: 1px solid black;margin-bottom:5px;">
        <label>
          域名：<input required  value="${domain}" name="[${index}].domain" />
        </label>
        <button type="button" class="add-plugin" >添加plugin</button>
        ${pluginHtml}
      </div>`;
    };
    const form = $(".form");
    $(".add-domain").on("click", function () {
      const curNum = form.find(".domain-block").length;
      const newDomain = renderDomain(curNum, "", []);
      form.append(newDomain);
    });
    form.on("click", ".add-plugin", function () {
      console.log(this);
      const domainBlock = $(this).parents(".domain-block");
      const plugins = domainBlock.find(".plugin-item");
      const newPlugin = renderPlugin(
        `[${domainBlock.data("index")}]`,
        plugins.length,
        "",
        ""
      );
      domainBlock.find(".plugin-block").append(newPlugin);
    });

    let oldValue;
    $.ajax(location.pathname + "cgi-bin/console-config").then(
      (res) => {
        oldValue = res;
        if (res.length === 0) form.append(renderDomain(0, "", []), "", []);
        else {
          res.forEach((item, index) => {
            form.append(renderDomain(index, item.domain, item.plugin || []));
          });
        }
      },
      (err) => {
        console.error(err);
      }
    );

    const applyBtn = $(".apply");
    let newValue = [];
    form.on("input", () => {
      newValue = [];
      let vals = form.serializeArray();
      vals.forEach(({ name, value }) => {
        _.set(newValue, name, value);
      });

      if (JSON.stringify(newValue) !== JSON.stringify(oldValue)) {
        applyBtn.attr("disabled", false);
      } else {
        applyBtn.attr("disabled", true);
      }
    });

    applyBtn.on("click", () => {
      if (form[0].reportValidity()) {
        console.log(newValue);
        alert("应用成功");
        applyBtn.attr("disabled", true);
        $.ajax(location.pathname + "cgi-bin/console-config", {
          method: "post",
          contentType: "application/json; charset=utf-8",
          dataType: "json",
          data: JSON.stringify(newValue),
        }).then((res) => {
          console.log(res);
        });
      }
    });
  </script>
</html>
